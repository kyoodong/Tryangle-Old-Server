<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gomson.tryangle.dao.ImageDao">

    <insert id="insertImage" parameterType="Image" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tryangle_image VALUES (
            0, #{url}, #{author}, #{compositionProblemCount}, #{score}
        )
    </insert>

    <insert id="insertObject" parameterType="ObjectComponent" useGeneratedKeys="true" keyProperty="objectComponent.id">
        INSERT INTO tryangle_image_object VALUES (
            0,
            #{imageId},
            #{objectComponent.clazz},
            #{objectComponent.centerPointX},
            #{objectComponent.centerPointY},
            #{objectComponent.area}
        )
    </insert>

    <insert id="insertEffectiveLine" parameterType="LineComponent" useGeneratedKeys="true" keyProperty="lineComponent.id">
        INSERT INTO tryangle_image_effective_line VALUES (
            0,
            #{imageId},
            #{lineComponent.startX},
            #{lineComponent.startY},
            #{lineComponent.endX},
            #{lineComponent.endY}
        )
    </insert>

    <insert id="insertDominantColor">
        INSERT INTO tryangle_image_dominant_color VALUES (
            0,
            #{imageId},
            #{colorId}
        )
    </insert>

    <insert id="insertHumanPose">
        INSERT INTO tryangle_object_person_pose VALUES (
            0, #{objectId}, #{poseId}
        )
    </insert>

    <select id="selectUnscoredImageList" resultType="Image">
        SELECT * FROM tryangle_image
        WHERE author = #{userId}
        AND score = -1
    </select>

    <update id="updateImageScore">
        UPDATE tryangle_image SET
        score = #{score}
        WHERE id = #{imageId}
    </update>

    <select id="selectImageUrlByObject" resultType="String">
        SELECT url FROM (
            SELECT i.*, tio.object_id as object_id, COUNT(tio.object_id) as object_count
            FROM tryangle_image i
            JOIN tryangle_image_object tio
            ON i.id = tio.image_id
            GROUP BY i.id, tio.object_id
        ) mi
        WHERE
        <foreach collection="objectClassCount" index="key" item="value" separator="OR">
        (mi.object_id = #{key} AND mi.object_count = #{value})
        </foreach>
        GROUP BY url
    </select>

</mapper>