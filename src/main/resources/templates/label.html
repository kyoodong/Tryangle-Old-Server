<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>레이블</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>
<body>
<script th:inline="javascript">
    Date.prototype.convertLocalTime = function() {
        this.setTime(new Date(this.getTime() - this.getTimezoneOffset() * 60 * 1000).getTime())
        return this
    }

    $(document).ready(function() {

        const pathParam = window.location.pathname.split("/")
        const category = pathParam[2]
        const user = pathParam[3]
        let index = 0

        const limit = 10
        let labelImageList = []
        let anchorDatetime = new Date().convertLocalTime()
        let isLoading = false

        $.getJSON("/label/api/" + category + "/" + user, {
            'limit': limit
        }, function(res) {
            if (res.length > 0) {
                labelImageList = labelImageList.concat(res)
                $('#img').attr('src', '/training_image/' + res[index].id)
            }
        })

        function goLeft() {
            index--

            if (index < 0) {
                if (isLoading)
                    return
                isLoading = true
                $.getJSON("/label/api/" + category + "/" + user + "/last", {
                    'anchorDatetime': anchorDatetime.toISOString(),
                    'limit': limit
                }, function(res) {
                    isLoading = false
                    if (res.length > 0) {
                        labelImageList = res.concat(labelImageList.slice(0, limit))
                        index += limit
                        anchorDatetime = new Date(labelImageList[0].scoredAt).convertLocalTime()
                        console.log(anchorDatetime.toISOString())
                        $('#img').attr('src', '/training_image/' + labelImageList[index].id)
                    } else {
                        index = 0
                    }
                })
            } else {
                $('#img').attr('src', '/training_image/' + labelImageList[index].id)
            }
        }

        function goRight() {
            index++
            if (index === labelImageList.length) {
                if (isLoading)
                    return

                isLoading = true
                $.getJSON("/label/api/" + category + "/" + user,{
                    'limit': limit
                }, function(res) {
                    isLoading = false
                    if (res.length > 0) {
                        labelImageList = labelImageList.concat(res).slice(limit)
                        anchorDatetime = new Date(labelImageList[0].scoredAt)
                        index -= limit
                        $('#img').attr('src', '/training_image/' + labelImageList[index].id)
                    }
                })
            } else {
                $('#img').attr('src', '/training_image/' + labelImageList[index].id)
            }
        }

        function score(id, score, after) {
            const header = [[${_csrf.parameterName}]]
            const token = [[${_csrf.token}]]
            let data = {score: score}
            data[header] = token

            $.ajax({
                url: '/label/api/score/' + id,
                type: 'put',
                data: data,
                success: function(res) {
                    if (res === true) {
                        after()
                    } else {
                        alert("실패")
                    }
                }
            })
        }

        $(document).keydown(function(event) {
            // 좌
            if (event.keyCode === 37) {
                goLeft()
            }
            // 우
            if (event.keyCode === 39) {
                goRight()
            }
            // 0
            if (event.keyCode === 48) {
                score(labelImageList[index].id, -1, goRight)
            }
            // 1
            if (event.keyCode === 49) {
                score(labelImageList[index].id, 1, goRight)
            }
            // 2
            if (event.keyCode === 50) {
                score(labelImageList[index].id, 2, goRight)
            }
            // 3
            if (event.keyCode === 51) {
                score(labelImageList[index].id, 3, goRight)
            }
            // 4
            if (event.keyCode === 52) {
                score(labelImageList[index].id, 4, goRight)
            }
            // 5
            if (event.keyCode === 53) {
                score(labelImageList[index].id, 5, goRight)
            }
            // backspace
            if (event.keyCode === 8) {
                score(labelImageList[index].id, 0, goLeft)
            }
        })
    })
</script>
<h1>레이블</h1>
점수 : 1,2,3,4,5
이전 : <-
다음 : ->
취소 : 0

<img id="img" style="width: 300px; height: 300px;"/>
<ul>
</ul>
</body>
</html>