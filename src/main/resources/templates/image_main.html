<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>메인</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>
<body>
<script th:inline="javascript">
    function getCookie(cookieName) {
        var cookieValue=null;
        if(document.cookie){
            var array=document.cookie.split((escape(cookieName)+'='));
            if(array.length >= 2){
                var arraySub=array[1].split(';');
                cookieValue=unescape(arraySub[0]);
            }
        }
        return cookieValue;
    }

    $(document).ready(function() {
        var longAccessToken = getCookie("longAccessToken")
        var expireTime = getCookie("expireTime")
        const now = new Date().getTime()
        const instagramCode = [[${code}]]
        console.log(instagramCode)

        // 최초 접속 or 토큰 만료 시
        if ((longAccessToken == null || expireTime == null || expireTime <= now) && !instagramCode) {
            window.location.href = "https://api.instagram.com/oauth/authorize?client_id=332072644461491&redirect_uri=https://localhost:9999/&scope=user_profile,user_media&response_type=code";
        } else {
            if (instagramCode) {
                $.post("https://api.instagram.com/oauth/access_token", {
                    "client_id": "332072644461491",
                    "client_secret": "77d57fce6307547bef7301da1c9f7484",
                    "grant_type": "authorization_code",
                    "redirect_uri": "https://localhost:9999/",
                    "code": instagramCode
                }, function(res) {
                    // 인스타그램 단기 실행 코드
                    const accessToken = res.access_token
                    const userId = res.user_id

                    $.getJSON("https://graph.instagram.com/access_token", {
                        "grant_type": "ig_exchange_token",
                        "client_secret": "77d57fce6307547bef7301da1c9f7484",
                        "access_token": accessToken
                    }, function(res) {
                        longAccessToken = res.access_token
                        const now = new Date().getTime()
                        expireTime = now + res.expires_in

                        console.log(longAccessToken, now, expireTime)
                        document.cookie = "expireTime=" + expireTime
                        document.cookie = "longAccessToken=" + longAccessToken
                    })
                })
            }
        }

        const instagramToken = getCookie("instagramToken")
        const user = [[${user}]]
        console.log(user)
        const userID = getCookie("userID")
        console.log(userID)

        $('#instagram-token').text("인스타그램 토큰 : " + instagramToken)

        $('#submit').click(function() {
            const search = $('#search').val()
            $.getJSON("https://graph.facebook.com/v7.0/me/accounts", {
                'access_token': instagramToken
            }, function (response) {
                console.log(response.data[0])
                const id = response.data[0].id

                $.getJSON("https://graph.facebook.com/v7.0/" + id, {
                    'fields': 'instagram_business_account',
                    'access_token' : instagramToken
                }, function(response) {
                    const business_account = response.instagram_business_account.id

                    $.getJSON("https://graph.facebook.com/v7.0/ig_hashtag_search", {
                        'user_id': business_account,
                        'q': search,
                        'access_token' : instagramToken
                    }, function(response) {
                        const object_id_list = response.data
                        for (const key in object_id_list) {
                            $.getJSON("https://graph.facebook.com/v7.0/" + object_id_list[key].id + "/top_media", {
                                'user_id': business_account,
                                'access_token' : instagramToken
                            }, function(response) {
                                const data = response.data
                                const paging = response.paging;

                                for (const index in data) {
                                    const id = data[index].id
                                    console.log(id)
                                    $.getJSON("https://graph.instagram.com/" + id, {
                                        'fields': "id,media_type,media_url,username,timestamp",
                                        'access_token' : longAccessToken
                                    }, function(response) {
                                        console.log(response)
                                    })
                                }
                            })
                        }
                    })
                })
            })
        })
    })
</script>
<h1>메인</h1>
<div id="instagram-token">
</div>

<div>
    <input id="search"> <button id="submit">검색</button>
</div>
</body>
</html>