<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>레이블</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>
<body>
<script th:inline="javascript">
    Date.prototype.convertLocalTime = function() {
        this.setTime(new Date(this.getTime() - this.getTimezoneOffset() * 60 * 1000).getTime())
        return this
    }

    $(document).ready(function() {
        canvas = document.getElementById("img-canvas");
        blank_canvas = document.getElementById("blank-img-canvas");
        context = canvas.getContext("2d");
        blank_context = blank_canvas.getContext("2d");

        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;

        blank_canvas.width = rect.width
        blank_canvas.height = rect.height

        // 마우스 리스너 등록. e는 MouseEvent 객체
        canvas.addEventListener("mousemove", function (e) { move(e) }, false);
        canvas.addEventListener("mousedown", function (e) { down(e) }, false);
        canvas.addEventListener("mouseup", function (e) { up(e) }, false);
        canvas.addEventListener("mouseout", function (e) { out(e) }, false);

        var startX=0, startY=0; // 드래깅동안, 처음 마우스가 눌러진 좌표
        var drawing=false;
        var curSrc = ''

        function draw(curX, curY) {
            context.lineWidth = 2; // 선 굵기를 2로 설정
            context.strokeStyle = "#FF0000";
            context.lineJoin = "round";

            blank_context.lineWidth = 2
            blank_context.strokeStyle = "#FFFFFF";
            blank_context.lineJoin = "round";

            context.beginPath();
            context.moveTo(startX, startY);
            context.lineTo(curX, curY);
            context.closePath()
            context.stroke();

            blank_context.beginPath();
            blank_context.moveTo(startX, startY);
            blank_context.lineTo(curX, curY);
            blank_context.closePath()
            blank_context.stroke();
        }

        function down(e) {
            startX = e.offsetX; startY = e.offsetY;
            drawing = true;
        }

        function up(e) { drawing = false; }

        function move(e) {
            if(!drawing) return; // 마우스가 눌러지지 않았으면 리턴
            var curX = e.offsetX, curY = e.offsetY;
            draw(curX, curY);
            startX = curX; startY = curY;
        }

        function out(e) { drawing = false; }



        function showScore(score) {
            $('#score-board-text').text(score)
            $('#score-board').show().fadeOut()
        }

        const pathParam = window.location.pathname.split("/")
        const category = pathParam[2]
        const user = pathParam[3]
        let index = 0

        const limit = 10
        let labelImageList = []
        let anchorDatetime = new Date().convertLocalTime()
        let nextAnchorDatetime = new Date().convertLocalTime()
        let isLoading = false

        function drawInCanvas(src) {
            blank_context.fillStyle = "black";
            blank_context.clearRect(0, 0, blank_canvas.width, blank_canvas.height)
            blank_context.fillRect(0, 0, blank_canvas.width, blank_canvas.height)

            curSrc = src
            const image = new Image(640, 640)
            image.src = src
            image.onload = function() {
                context.drawImage(this, 0, 0, 640, 640);
            }
        }

        $.getJSON("/label/api/" + category + "/" + user + "/next", {
            'anchorDatetime': nextAnchorDatetime.toISOString(),
            'limit': limit
        }, function(res) {
            if (res.length > 0) {
                labelImageList = labelImageList.concat(res)
                $('#score').text(res[index].score)
                drawInCanvas('/training_image/' + res[index].id)
            }
        })

        function goLeft() {
            index--

            if (index < 0) {
                if (isLoading)
                    return
                isLoading = true
                $.getJSON("/label/api/" + category + "/" + user + "/last", {
                    'anchorDatetime': anchorDatetime.toISOString(),
                    'limit': limit
                }, function(res) {
                    isLoading = false
                    if (res.length > 0) {
                        labelImageList = res.reverse().concat(labelImageList.slice(0, limit))
                        index += limit
                        anchorDatetime = new Date(labelImageList[0].scoredAt).convertLocalTime()
                        nextAnchorDatetime = new Date(res[res.length - 1].scoredAt).convertLocalTime()
                        $('#score').text(labelImageList[index].score)
                        drawInCanvas('/training_image/' + labelImageList[index].id)
                    } else {
                        index = 0
                    }
                })
            } else {
                $('#score').text(labelImageList[index].score)
                drawInCanvas('/training_image/' + labelImageList[index].id)
            }
        }

        function goRight() {
            index++
            if (index >= labelImageList.length) {
                if (isLoading)
                    return

                isLoading = true
                $.getJSON("/label/api/" + category + "/" + user + "/next", {
                    'limit': limit
                }, function(res) {
                    isLoading = false
                    if (res.length > 0) {
                        labelImageList = labelImageList.concat(res).slice(limit)

                        if (labelImageList[0].scoredAt == null) {
                            anchorDatetime = new Date().convertLocalTime()
                        } else {
                            anchorDatetime = new Date(labelImageList[0].scoredAt).convertLocalTime()
                        }

                        if (labelImageList[labelImageList.length - 1].scoredAt == null) {
                            nextAnchorDatetime = new Date().convertLocalTime()
                        } else {
                            nextAnchorDatetime = new Date(labelImageList[labelImageList.length - 1].scoredAt).convertLocalTime()
                        }
                        index -= limit
                        $('#score').text(labelImageList[index].score)
                        drawInCanvas('/training_image/' + labelImageList[index].id)
                    }
                })
            } else {
                $('#score').text(labelImageList[index].score);
                drawInCanvas('/training_image/' + labelImageList[index].id)
            }
        }

        function score(item, score, after) {
            const header = [[${_csrf.parameterName}]]
            const token = [[${_csrf.token}]]
            // var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            var image = blank_canvas.toDataURL("image/jpeg");
            let data = {score: score}
            data[header] = token
            data['imageData'] = image

            $.ajax({
                url: '/label/api/score/' + item.id,
                type: 'put',
                data: data,
                success: function(res) {
                    if (res === true) {
                        item.score = score
                        item.scoredAt = new Date().convertLocalTime()
                        showScore(score)
                        after()
                    } else {
                        alert("실패")
                    }
                }
            })
        }

        $(document).keydown(function(event) {
            // 좌
            if (event.keyCode === 37) {
                goLeft()
            }
            // 우
            if (event.keyCode === 39) {
                goRight()
            }
            // 0
            if (event.keyCode === 48) {
                score(labelImageList[index], -1, goRight)
            }
            // 1
            if (event.keyCode === 49) {
                score(labelImageList[index], 1, goRight)
            }
            // 2
            if (event.keyCode === 50) {
                score(labelImageList[index], 2, goRight)
            }
            // 3
            if (event.keyCode === 51) {
                score(labelImageList[index], 3, goRight)
            }
            // 4
            if (event.keyCode === 52) {
                score(labelImageList[index], 4, goRight)
            }
            // 5
            if (event.keyCode === 53) {
                score(labelImageList[index], 5, goRight)
            }
            // backspace
            if (event.keyCode === 8) {
                context.clearRect(0, 0, canvas.width, canvas.height)
                drawInCanvas(curSrc)
            }
        })
    })



    var canvas, context;
</script>
<h1>레이블</h1>
<span>
    <div>
        <canvas id="img-canvas" style="width: 640px; height: 640px;"/>
        점수 : <span id="score" style="font-size: 40px;"></span>
    </div>
</span>

<h1>사용법</h1>
<div>점수 : 1,2,3,4,5</div>
<div>취소 : Backspace</div>
<div>오브젝트 미발견 : 0</div>
<div>이전 : <-</div>
<div>다음 : -></div>

<canvas id="blank-img-canvas" style="width: 640px; height: 640px;"/>

<div id="score-board" style="width: 150px; position: fixed; top: 150px; left: 300px; text-align: center; background: #DDD; display: none;">
    <h1 id="score-board-text">10</h1>
</div>
</body>
</html>